name: QEMU Windows VNC

on: workflow_dispatch

jobs:
  run-qemu:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Install QEMU + Tailscale
        run: |
          sudo apt update
          sudo apt install qemu-kvm tailscale -y

      - name: Download Windows
        run: |
          wget -O win.iso "https://archive.org/download/en_windows_server_2022x64_dvd_/en_windows_server_2022x64_dvd_.iso"
          qemu-img create -f qcow2 disk.qcow2 300G

      - name: Auth Tailscale
        run: |
          sudo tailscaled &
          sleep 5
          sudo tailscale up --authkey=${{ secrets.TS_AUTHKEY }} --hostname=win-qemu

      - name: Run QEMU Windows (VNC on 5900)
        run: |
          qemu-system-x86_64 -M q35 -usb -device qemu-xhci -device usb-tablet -device usb-kbd -enable-kvm -m 24G -smp 12 -drive file=disk.qcow2,format=qcow2 -cdrom win.iso -device ich9-intel-hda -device hda-duplex -netdev user,id=n1 -device e1000,netdev=n1 -vnc 0.0.0.0:0
